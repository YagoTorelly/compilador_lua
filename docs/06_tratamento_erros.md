# üö® Tratamento de Erros

[‚Üê Anterior: Gera√ß√£o de C√≥digo](05_geracao_codigo.md) | [‚Üë √çndice](README.md) | [Pr√≥ximo: Estrutura do Projeto ‚Üí](07_estrutura_projeto.md)

---

## üìã √çndice

- [O que √© Tratamento de Erros?](#-para-iniciantes-o-que-√©-tratamento-de-erros)
- [Tipos de Erros](#-tipos-de-erros)
- [Sistema de Erros](#-detalhes-t√©cnicos-sistema-de-erros)
- [Recupera√ß√£o de Erros](#-recupera√ß√£o-de-erros)
- [Exemplos Pr√°ticos](#-exemplos-pr√°ticos)

---

## üí° Para Iniciantes: O que √© Tratamento de Erros?

### Defini√ß√£o Simples

**Tratamento de erros** √© o processo de **detectar problemas** no c√≥digo e **informar o programador** de forma clara sobre o que est√° errado e onde.

### Por que √© importante?

Imagine escrever c√≥digo e receber mensagens assim:

‚ùå **Ruim:**
```
Erro na linha 42
```

‚úÖ **Bom:**
```
Erro sint√°tico na linha 42: Esperado 'then', encontrado 'print'
  if x > 5
           ^
  Dica: Estruturas 'if' requerem 'then' antes do bloco
```

### Tipos de Problemas

Um compilador pode encontrar tr√™s tipos principais de problemas:

1. **Erros L√©xicos** - Caracteres inv√°lidos
2. **Erros Sint√°ticos** - Estrutura errada
3. **Erros Sem√¢nticos** - N√£o faz sentido

---

## üìö Tipos de Erros

### 1. Erros L√©xicos ‚ùå

**Quando ocorrem?** Durante a tokeniza√ß√£o (an√°lise l√©xica).

**O que detectam?** Caracteres inv√°lidos na linguagem.

#### Exemplo:

**C√≥digo:**
```lua
local x = @10
```

**Erro:**
```
‚ö†Ô∏è ERRO L√âXICO: Caractere inv√°lido '@' na linha 1
```

**Token gerado:**
```
Linha 1 | ERRO | '@'
```

**Explica√ß√£o:** O caractere `@` n√£o √© v√°lido em Moonlet.

### 2. Erros Sint√°ticos ‚ùå

**Quando ocorrem?** Durante o parsing (an√°lise sint√°tica).

**O que detectam?** Estrutura gramatical incorreta.

#### Exemplo 1: Falta 'then'

**C√≥digo:**
```lua
if x > 5
    print("ok")
end
```

**Erro:**
```
Erro sint√°tico: Token esperado n√£o encontrado
  Esperado 'then', encontrado 'print'
  em linha 2, coluna 0
```

#### Exemplo 2: Falta 'end'

**C√≥digo:**
```lua
if x > 5 then
    print("ok")
-- ‚ùå Falta 'end'
```

**Erro:**
```
Erro sint√°tico: Esperado 'end', encontrado 'EOS'
```

### 3. Erros Sem√¢nticos ‚ùå

**Quando ocorrem?** Durante an√°lise sem√¢ntica.

**O que detectam?** C√≥digo que n√£o faz sentido.

#### Exemplo 1: Vari√°vel n√£o declarada

**C√≥digo:**
```lua
if y > 0 then  -- ‚ùå y nunca foi declarado
    print("ok")
end
```

**Erro:**
```
Erro sem√¢ntico: Vari√°vel 'y' n√£o declarada
  em linha 1, coluna 0
```

#### Exemplo 2: Declara√ß√£o duplicada

**C√≥digo:**
```lua
local a = 1
local a = 2  -- ‚ùå a j√° foi declarado
```

**Erro:**
```
Erro sem√¢ntico: Vari√°vel 'a' j√° declarada
  em linha 2, coluna 0
```

---

## üîß Detalhes T√©cnicos: Sistema de Erros

### Localiza√ß√£o no Projeto

```
src/errors/erros_moonlet.py
```

**Linhas de c√≥digo:** ~111

### Hierarquia de Classes

```
ErroCompilacao (base)
‚îú‚îÄ‚îÄ ErroLexico
‚îú‚îÄ‚îÄ ErroSintatico
‚îî‚îÄ‚îÄ ErroSemantico
```

### Estrutura de Posi√ß√£o de Erro

```python
@dataclass
class PosicaoErro:
    """Representa a posi√ß√£o de um erro no c√≥digo fonte"""
    linha: int
    coluna: int
    arquivo: Optional[str] = None
    
    def __str__(self):
        if self.arquivo:
            return f"{self.arquivo}:{self.linha}:{self.coluna}"
        return f"linha {self.linha}, coluna {self.coluna}"
```

**Exemplo de uso:**
```python
posicao = PosicaoErro(linha=5, coluna=10, arquivo="exemplo.moonlet")
print(posicao)
# Sa√≠da: exemplo.moonlet:5:10
```

---

## üéØ Classes de Erro

### 1. ErroCompilacao (Classe Base)

```python
class ErroCompilacao(Exception):
    """Classe base para todos os erros de compila√ß√£o"""
    
    def __init__(self, mensagem: str, posicao: Optional[PosicaoErro] = None):
        self.mensagem = mensagem
        self.posicao = posicao
        super().__init__(self._formatar_mensagem())
    
    def _formatar_mensagem(self) -> str:
        if self.posicao:
            return f"Erro em {self.posicao}: {self.mensagem}"
        return self.mensagem
```

### 2. ErroLexico

```python
class ErroLexico(ErroCompilacao):
    """Erro durante a an√°lise l√©xica"""
    
    def __init__(self, mensagem: str, posicao: Optional[PosicaoErro] = None):
        super().__init__(f"Erro l√©xico: {mensagem}", posicao)
```

**Exemplo:**
```python
raise ErroLexico(
    "Caractere inv√°lido '@'",
    PosicaoErro(linha=1, coluna=10)
)
```

### 3. ErroSintatico

```python
class ErroSintatico(ErroCompilacao):
    """Erro durante a an√°lise sint√°tica"""
    
    def __init__(self, mensagem: str, posicao: Optional[PosicaoErro] = None, 
                 token_esperado: Optional[str] = None, 
                 token_encontrado: Optional[str] = None):
        self.token_esperado = token_esperado
        self.token_encontrado = token_encontrado
        
        if token_esperado and token_encontrado:
            mensagem_completa = (
                f"Erro sint√°tico: {mensagem}. "
                f"Esperado '{token_esperado}', encontrado '{token_encontrado}'"
            )
        else:
            mensagem_completa = f"Erro sint√°tico: {mensagem}"
            
        super().__init__(mensagem_completa, posicao)
```

**Exemplo:**
```python
raise ErroSintatico(
    "Token esperado n√£o encontrado",
    PosicaoErro(linha=3, coluna=0),
    token_esperado='then',
    token_encontrado='print'
)
```

### 4. ErroSemantico

```python
class ErroSemantico(ErroCompilacao):
    """Erro durante a an√°lise sem√¢ntica"""
    
    def __init__(self, mensagem: str, posicao: Optional[PosicaoErro] = None):
        super().__init__(f"Erro sem√¢ntico: {mensagem}", posicao)
```

**Exemplo:**
```python
raise ErroSemantico(
    "Vari√°vel 'x' n√£o declarada",
    PosicaoErro(linha=5, coluna=0)
)
```

---

## üìä Relat√≥rio de Erros

### Classe RelatorioErros

```python
class RelatorioErros:
    """Classe para coletar e reportar m√∫ltiplos erros"""
    
    def __init__(self):
        self.erros: List[ErroCompilacao] = []
        self.avisos: List[str] = []
    
    def adicionar_erro(self, erro: ErroCompilacao):
        """Adiciona um erro ao relat√≥rio"""
        self.erros.append(erro)
    
    def tem_erros(self) -> bool:
        """Verifica se h√° erros"""
        return len(self.erros) > 0
    
    def imprimir_relatorio(self):
        """Imprime todos os erros"""
        if self.tem_erros():
            print("=== ERROS ENCONTRADOS ===")
            for i, erro in enumerate(self.erros, 1):
                print(f"{i}. {erro}")
            print()
```

### Uso no Parser

```python
class AnalisadorSintaticoMoonlet:
    def __init__(self, lexer):
        # ...
        self.relatorio_erros = RelatorioErros()
    
    def analisar(self):
        declaracoes = []
        
        while self.token_atual.tipo != EOS:
            try:
                decl = self._analisar_declaracao()
                declaracoes.append(decl)
            except ErroSintatico as e:
                # ‚úÖ Adiciona erro ao relat√≥rio
                self.relatorio_erros.adicionar_erro(e)
                print(f"‚ö†Ô∏è ERRO SINT√ÅTICO: {e}")
                
                # Tenta recuperar
                self._pular_ate_proximo_valido()
        
        return ProgramNode(declaracoes)
```

---

## üîÑ Recupera√ß√£o de Erros

### O que √©?

**Recupera√ß√£o de erros** permite que o compilador continue analisando o c√≥digo mesmo ap√≥s encontrar um erro, detectando **m√∫ltiplos erros** em uma √∫nica execu√ß√£o.

### Estrat√©gia: Panic Mode

Quando o parser encontra um erro, ele **pula tokens** at√© encontrar um ponto seguro para continuar.

#### M√©todo: `_pular_ate_proximo_valido()`

```python
def _pular_ate_proximo_valido(self):
    """Pula tokens at√© encontrar um v√°lido para continuar an√°lise"""
    while (self.token_atual and 
           self.token_atual.tipo not in [EOS, PALAVRA_CHAVE] and
           not (self.token_atual.tipo == IDENTIFICADOR)):
        print(f"üîÑ Pulando token: '{self.token_atual.lexema}'")
        self._avancar_token()
```

### Pontos de Sincroniza√ß√£o

Tokens considerados "seguros" para continuar:

- **Palavras-chave:** `if`, `while`, `for`, `local`, `function`, `end`
- **Identificadores:** In√≠cio de comandos
- **EOS:** Fim do arquivo

### Exemplo de Recupera√ß√£o

**C√≥digo com m√∫ltiplos erros:**
```lua
if x > 5  -- ‚ùå ERRO 1: falta 'then'
    print("ok")
end

local a = 1
local a = 2  -- ‚ùå ERRO 2: declara√ß√£o duplicada
```

**Comportamento:**
```
‚ö†Ô∏è ERRO SINT√ÅTICO: Esperado 'then', encontrado 'print'
üîÑ Pulando token: 'print'
‚úì Bloco analisado
‚úì 'end' encontrado

‚ö†Ô∏è ERRO SEM√ÇNTICO: Vari√°vel 'a' j√° declarada

=== ERROS ENCONTRADOS ===
1. Erro sint√°tico: Token esperado n√£o encontrado. 
   Esperado 'then', encontrado 'print' em linha 1, coluna 0
2. Erro sem√¢ntico: Vari√°vel 'a' j√° declarada em linha 6, coluna 0
```

### Recupera√ß√£o Tolerante

O parser tenta continuar mesmo com erros:

```python
def _analisar_comando_if(self):
    self._consumir_palavra_chave('if')
    condicao = self._analisar_expressao()
    
    # ‚úÖ Tenta consumir 'then'
    if self._verificar_palavra_chave('then'):
        self._avancar_token()
    else:
        # ‚ùå ERRO: Reporta mas CONTINUA
        erro = criar_erro_token_esperado('then', ...)
        self.relatorio_erros.adicionar_erro(erro)
        print(f"‚ö†Ô∏è ERRO SINT√ÅTICO: {erro}")
    
    # üîÑ Continua parsing do bloco
    bloco = self._analisar_bloco()
    # ...
```

---

## üõ†Ô∏è Fun√ß√µes Auxiliares

### 1. criar_erro_token_esperado()

```python
def criar_erro_token_esperado(
    token_esperado: str, 
    token_encontrado: str, 
    posicao: PosicaoErro
) -> ErroSintatico:
    return ErroSintatico(
        "Token esperado n√£o encontrado",
        posicao,
        token_esperado=token_esperado,
        token_encontrado=token_encontrado
    )
```

**Uso:**
```python
if not self._verificar_palavra_chave('then'):
    raise criar_erro_token_esperado(
        'then',
        self.token_atual.lexema,
        self._criar_posicao_erro()
    )
```

### 2. criar_erro_fim_arquivo_inesperado()

```python
def criar_erro_fim_arquivo_inesperado(posicao: PosicaoErro) -> ErroSintatico:
    return ErroSintatico(
        "Fim de arquivo inesperado",
        posicao
    )
```

### 3. criar_erro_token_inesperado()

```python
def criar_erro_token_inesperado(
    token_encontrado: str, 
    posicao: PosicaoErro
) -> ErroSintatico:
    return ErroSintatico(
        "Token inesperado",
        posicao,
        token_encontrado=token_encontrado
    )
```

---

## üìù Exemplos Pr√°ticos

### Exemplo 1: Erro L√©xico Simples

**C√≥digo:**
```lua
local x = $10
```

**Execu√ß√£o:**
```python
lexer = AnalisadorLexicoMoonlet(codigo)
token = lexer.proximo_token()

while token.tipo != EOS:
    if token.tipo == ERRO:
        print(f"‚ö†Ô∏è ERRO L√âXICO: Caractere inv√°lido '{token.lexema}'")
    token = lexer.proximo_token()
```

**Sa√≠da:**
```
Linha 1 | PALAVRA_CHAVE  | 'local'
Linha 1 | IDENTIFICADOR  | 'x'
Linha 1 | OPERADOR       | '='
Linha 1 | ERRO           | '$'     ‚ö†Ô∏è ERRO L√âXICO
Linha 1 | NUMERO         | '10'
```

### Exemplo 2: Erro Sint√°tico com Recupera√ß√£o

**C√≥digo:**
```lua
if x > 5
    print("ok")
end
```

**Execu√ß√£o:**
```python
try:
    lexer = AnalisadorLexicoMoonlet(codigo)
    parser = AnalisadorSintaticoMoonlet(lexer)
    ast = parser.analisar()
    
    # Verifica se houve erros
    if parser.relatorio_erros.tem_erros():
        parser.relatorio_erros.imprimir_relatorio()
        
except Exception as e:
    print(f"Erro fatal: {e}")
```

**Sa√≠da:**
```
‚ö†Ô∏è ERRO SINT√ÅTICO: Esperado 'then', encontrado 'print'
üîÑ Parser continua...

=== ERROS ENCONTRADOS ===
1. Erro sint√°tico: Token esperado n√£o encontrado. 
   Esperado 'then', encontrado 'print' em linha 2, coluna 0
```

### Exemplo 3: M√∫ltiplos Erros

**C√≥digo:**
```lua
-- Erro 1: falta 'then'
if x > 5
    print("ok")
end

-- Erro 2: vari√°vel n√£o declarada
y = 10

-- Erro 3: declara√ß√£o duplicada
local a = 1
local a = 2
```

**Sa√≠da:**
```
‚ö†Ô∏è ERRO SINT√ÅTICO: Esperado 'then', encontrado 'print'
‚ö†Ô∏è ERRO SEM√ÇNTICO: Vari√°vel 'y' n√£o declarada
‚ö†Ô∏è ERRO SEM√ÇNTICO: Vari√°vel 'a' j√° declarada

=== ERROS ENCONTRADOS ===
1. Erro sint√°tico: Token esperado n√£o encontrado. 
   Esperado 'then', encontrado 'print' em linha 2, coluna 0
2. Erro sem√¢ntico: Vari√°vel 'y' n√£o declarada em linha 6, coluna 0
3. Erro sem√¢ntico: Vari√°vel 'a' j√° declarada em linha 10, coluna 0

‚ö†Ô∏è 3 erro(s) encontrado(s)!
```

---

## üéì Boas Pr√°ticas

### 1. Mensagens Claras

‚ùå **Ruim:**
```
Erro
```

‚úÖ **Bom:**
```
Erro sint√°tico: Esperado 'then', encontrado 'print'
  em linha 3, coluna 5
```

### 2. Informar Localiza√ß√£o

```python
raise ErroSintatico(
    "Token inv√°lido",
    PosicaoErro(linha=token.linha, coluna=0)
)
```

### 3. Continuar Ap√≥s Erros

N√£o pare no primeiro erro - detecte o m√°ximo poss√≠vel em uma execu√ß√£o.

### 4. Categorizar Erros

Use hierarquia de classes para diferentes tipos de erros.

---

## üìä Compara√ß√£o de Erros

| Tipo | Fase | Detecta | Exemplo |
|------|------|---------|---------|
| **L√©xico** | Tokeniza√ß√£o | Caracteres inv√°lidos | `@`, `$` |
| **Sint√°tico** | Parsing | Estrutura incorreta | Falta `then`, `end` |
| **Sem√¢ntico** | An√°lise sem√¢ntica | Sem sentido | Var n√£o declarada |

---

## ‚úÖ Resumo

### O que o Sistema de Erros faz?

‚úÖ Detecta erros l√©xicos  
‚úÖ Detecta erros sint√°ticos  
‚úÖ Detecta erros sem√¢nticos  
‚úÖ Reporta m√∫ltiplos erros  
‚úÖ Tenta recuperar e continuar  
‚úÖ Fornece mensagens claras  

### Caracter√≠sticas

‚úÖ Hierarquia de classes  
‚úÖ Posicionamento preciso  
‚úÖ Relat√≥rios formatados  
‚úÖ Panic mode recovery  

---

## üéØ Pr√≥ximos Passos

Agora que voc√™ entende como o compilador trata erros, vamos ver a **estrutura completa do projeto**:

[‚ñ∂Ô∏è Pr√≥ximo: Estrutura do Projeto ‚Üí](07_estrutura_projeto.md)

Ou explore outros t√≥picos:

- [‚öôÔ∏è Voltar √† Gera√ß√£o de C√≥digo](05_geracao_codigo.md)
- [üìö Ver Exemplos Pr√°ticos](08_exemplos_uso.md)
- [üîß Refer√™ncia T√©cnica Completa](09_referencia_tecnica.md)

---

[‚Üê Anterior: Gera√ß√£o de C√≥digo](05_geracao_codigo.md) | [‚Üë √çndice](README.md) | [Pr√≥ximo: Estrutura do Projeto ‚Üí](07_estrutura_projeto.md)

